<?xml version="1.0" encoding="UTF-8" ?>
<project name="Aap" default="deployJnlp" basedir="..">
	<tstamp>
		<format property="build.timestamp" pattern="dd_MMM_yy_HH_mm_ss" />
	</tstamp> 
	
	<fail message="This ant file is supposed to be run from the eclipse plugin">
		<condition>
			<not>
				<isset property="eclipse.running" />
			</not>
		</condition>
	</fail>
	<taskdef name="buildDeployJnlp" classname="com.dexels.navajo.tipi.ant.projectbuilder.TipiBuildDeployJnlp" />
	<taskdef name="buildWikiSource" classname="com.dexels.navajo.tipi.ant.projectbuilder.TipiBuildWikiSource" />

	<property name="archive" value="${projectName}.jar" />
	<target name="deployJnlp">
		<delete dir="deploy/current" />
		<buildDeployJnlp codebase="${tipiAppServer}${projectName}" baseDir="${baseDir}" deployPath="${deployPath}" />

		<mkdir dir="deploy" />
		<mkdir dir="deploy/current" />
		<mkdir dir="deploy/archived" />
		<buildWikiSource sourceDir="tipi/" resourceDir="resource/" appCodebase="${tipiAppServer}${projectName}/resource/" docDir="deploy/current/source/" baseDir="${baseDir}" name="${projectName}"/>

		<echo message="Deployroot: %{deployRoot}">
		</echo>
		<copy todir="deploy/current">
			<fileset dir=".">
				<include name="tipi/**" />
				<include name="resource/**" />
				<include name="settings/**" />
			</fileset>
		</copy>
		<copy file="settings/template.html" tofile="deploy/current/index.html" />
		<replace file="deploy/current/index.html" token="@@APPNAME@@" value="${projectName}" />
		<replace file="deploy/current/index.html" token="@@TITLE@@" value="${title}" />
		<replace file="deploy/current/index.html" token="@@VENDOR@@" value="${vendor}" />
		<replace file="deploy/current/index.html" token="@@HOMEPAGE@@" value="${homepage}" />
		<replace file="deploy/current/index.html" token="@@SPLASH@@" value="${splash}" />
		<replace file="deploy/current/index.html" token="@@PROFILELINKLIST@@" value="${profileLinkList}" />
				<replace file="deploy/current/index.html" token="@@APPLINK@@" value="${tipiAppServer}${projectName}/DefaultLocal.jnlp"/>
		<replace file="deploy/current/index.html" token="@@TIMESTAMP@@" value="${build.timestamp}"  />
		<replace file="deploy/current/index.html" token="@@SOURCELINK@@" value="${tipiDoc}:${projectName}:info"  />
		<replace file="deploy/current/index.html" token="@@ICON@@" value="${icon}" />
				
		
		<zip destfile="${baseDir}/deploy/archived/${projectName}_${build.timestamp}.zip" basedir="${baseDir}/deploy/current"/>
		<mkdir dir="${projectName}"/>
		<copy todir="${projectName}">
			<fileset dir=".">
				<include name=".project"/>
			</fileset>
		</copy>
		<eclipse.refreshLocal resource="${ant.project.name}" />
		<scp trust="true" sftp="true" verbose="true" todir="${tipiAppServerSsh}">
			<fileset dir=".">
				<include name="${projectName}/**" />
			</fileset>
		</scp>
		<scp trust="true" sftp="true" verbose="true" todir="${tipiDocSsh}">
			<fileset dir=".">
				<include name="${projectName}/**" />
			</fileset>
		</scp>
		<delete dir="${projectName}"></delete>
		<scp trust="true" sftp="true" verbose="true" todir="${tipiAppServerSsh}${projectName}">
			<fileset dir="deploy/current">
				<include name="*.jnlp" />
				<include name="lib/**" />
				<include name="tipi/**" />
				<include name="resource/**" />
				<include name="index.html" />
			</fileset>
		</scp>

			<scp trust="true" sftp="true" verbose="true" todir="${tipiDocSsh}${projectName}">
				<fileset dir="deploy/current/source">
					<include name="**" />
				</fileset>
			</scp>

		
	</target>

	<target name="clean">
		<delete dir="lib"/>
		<delete dir=".tipiproject"/>
		<delete file="tipi/tipi.xsd"/>
		<delete file="Local.jnlp"/>
		<delete file="Remote.jnlp"/>		
		<eclipse.refreshLocal resource="${projectName}" />
	</target>

</project>