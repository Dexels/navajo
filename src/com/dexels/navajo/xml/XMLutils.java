/**
 * Title:        Navajo<p>
 * Description:  <p>
 * Copyright:    Copyright (c) Arjen Schoneveld<p>
 * Company:      Dexels<p>
 * @author Arjen Schoneveld
 * @version $Id$
 */
package com.dexels.navajo.xml;

import com.dexels.navajo.document.*;

import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.xml.sax.SAXParseException;
import org.w3c.dom.*;
import com.dexels.navajo.util.*;
import com.dexels.navajo.document.jaxpimpl.*;
import java.io.*;
import java.util.StringTokenizer;

public class XMLutils {

    public final static String XML_ESCAPE_DELIMITERS = "&'<>\"\n";
    public static String getElementValue(Node node) {

	return node.getNodeValue();
    }

    public static Navajo createNavajoInstance(String filename) throws NavajoException, FileNotFoundException {


          Document d = null;
          FileInputStream input = new FileInputStream(new File(filename));
          d = XMLDocumentUtils.createDocument(input, false);
          d.getDocumentElement().normalize();
          Navajo navajo = new NavajoImpl(d);
          return navajo;


    }

    public static Node findNode(Document d, String name) {

      Node body = d.getDocumentElement();

      return actualFindNode(body, name);
    }

    private static Node actualFindNode(Node node, String name)
    {
       if (node.getNodeName().equals(name)) {
            return node;
        }
        if (node.hasChildNodes())
            {
                NodeList list = node.getChildNodes();
                int size = list.getLength();

                for (int i=0; i < size; i++)
                    {
                        Node found = actualFindNode(list.item(i), name);
                        if (found != null) return found;
                    }
            }
        return null;
    }

    public static Node findNodeWithAttributeValue(Document d, String name, String attribute,
				    String value)     {
      Node body = d.getDocumentElement();

      return actualFindNodeWithAttributeValue(body, name, attribute, value);
    }

    public static Node findNode(Node node, String name)
    {

       if (node.getNodeName().equals(name)) {
            return node;
        }
        if (node.hasChildNodes())
            {
                NodeList list = node.getChildNodes();
                int size = list.getLength();

                for (int i=0; i < size; i++)
                    {
                        Node found = findNode(list.item(i), name);
                        if (found != null) return found;
                    }
            }
        return null;
    }

    private static Node actualFindNodeWithAttributeValue(Node node, String name, String attribute,
				    String value)     {

	if (node.getNodeName().equals(name)) {
	    Element e = (Element) node;
	    if (e.getAttribute(attribute).equals(value))
		return node;
	}
	if (node.hasChildNodes()) {
	    NodeList list = node.getChildNodes();
	    int size = list.getLength();
	    for (int i=0; i < size; i++)
		{
		    Node found =
			actualFindNodeWithAttributeValue(list.item(i), name, attribute, value);
		    if (found != null) return found;
		}
	}
        return null;
    }

    public static String string2unicode( String s ){

        Util.debugLog("in string2unicode(), s = " + s);

        StringBuffer tempBuffer = new StringBuffer(s);
        for (int i = 0; i < tempBuffer.length(); i++) {
            //if ( tempBuffer.charAt(i)=='&' ){
            //    tempBuffer.replace(i,i+1,"&amp;");
            //} else
            if ( tempBuffer.charAt(i)=='<' ){
                tempBuffer.replace(i,i+1,"&lt;");
            } else if ( tempBuffer.charAt(i)=='>' ){
                tempBuffer.replace(i,i+1,"&gt;");
            } else if ( tempBuffer.charAt(i)=='\"' ){
                tempBuffer.replace(i,i+1,"&quot;");
            }  else if ( tempBuffer.charAt(i)=='\'' ){
                tempBuffer.replace(i,i+1,"&apos;");
            } else if ( tempBuffer.charAt(i)=='€' ){
                tempBuffer.replace(i,i+1,"&#x20ac;");
            } else if ( tempBuffer.charAt(i)=='ƒ' ){
                tempBuffer.replace(i,i+1,"&#x0192;");
            } else if ( tempBuffer.charAt(i)=='¡' ){
                tempBuffer.replace(i,i+1,"&#x00a1;");
            } else if ( tempBuffer.charAt(i)=='¢' ){
                tempBuffer.replace(i,i+1,"&#x00a2;");
            } else if ( tempBuffer.charAt(i)=='£' ){
                tempBuffer.replace(i,i+1,"&#x00a3;");
            } else if ( tempBuffer.charAt(i)=='¤' ){
                tempBuffer.replace(i,i+1,"&#x00a4;");
            } else if ( tempBuffer.charAt(i)=='¥' ){
                tempBuffer.replace(i,i+1,"&#x00a5;");
            } else if ( tempBuffer.charAt(i)=='¦' ){
                tempBuffer.replace(i,i+1,"&#x00a6;");
            } else if ( tempBuffer.charAt(i)=='§' ){
                tempBuffer.replace(i,i+1,"&#x00a7;");
            } else if ( tempBuffer.charAt(i)=='¨' ){
                tempBuffer.replace(i,i+1,"&#x00a8;");
            } else if ( tempBuffer.charAt(i)=='©' ){
                tempBuffer.replace(i,i+1,"&#x00a9;");
            } else if ( tempBuffer.charAt(i)=='ª' ){
                tempBuffer.replace(i,i+1,"&#x00aa;");
            } else if ( tempBuffer.charAt(i)=='«' ){
                tempBuffer.replace(i,i+1,"&#x00ab;");
            } else if ( tempBuffer.charAt(i)=='®' ){
                tempBuffer.replace(i,i+1,"&#x00ae;");
            } else if ( tempBuffer.charAt(i)=='¯' ){
                tempBuffer.replace(i,i+1,"&#x00af;");
            } else if ( tempBuffer.charAt(i)=='°' ){
                tempBuffer.replace(i,i+1,"&#x00b0;");
            } else if ( tempBuffer.charAt(i)=='±' ){
                tempBuffer.replace(i,i+1,"&#x00b1;");
            } else if ( tempBuffer.charAt(i)=='²' ){
                tempBuffer.replace(i,i+1,"&#x00b2;");
            } else if ( tempBuffer.charAt(i)=='³' ){
                tempBuffer.replace(i,i+1,"&#x00b3;");
            } else if ( tempBuffer.charAt(i)=='´' ){
                tempBuffer.replace(i,i+1,"&#x00b4;");
            } else if ( tempBuffer.charAt(i)=='µ' ){
                tempBuffer.replace(i,i+1,"&#x00b5;");
            } else if ( tempBuffer.charAt(i)=='·' ){
                tempBuffer.replace(i,i+1,"&#x00b7;");
            } else if ( tempBuffer.charAt(i)=='¸' ){
                tempBuffer.replace(i,i+1,"&#x00b8;");
            } else if ( tempBuffer.charAt(i)=='¹' ){
                tempBuffer.replace(i,i+1,"&#x00b9;");
            } else if ( tempBuffer.charAt(i)=='º' ){
                tempBuffer.replace(i,i+1,"&#x00ba;");
            } else if ( tempBuffer.charAt(i)=='»' ){
                tempBuffer.replace(i,i+1,"&#x00bb;");
            } else if ( tempBuffer.charAt(i)=='¼' ){
                tempBuffer.replace(i,i+1,"&#x00bc;");
            } else if ( tempBuffer.charAt(i)=='½' ){
                tempBuffer.replace(i,i+1,"&#x00bd;");
            } else if ( tempBuffer.charAt(i)=='¾' ){
                tempBuffer.replace(i,i+1,"&#x00be;");
            } else if ( tempBuffer.charAt(i)=='¿' ){
                tempBuffer.replace(i,i+1,"&#x00bf;");
            } else if ( tempBuffer.charAt(i)=='À' ){
                tempBuffer.replace(i,i+1,"&#x00c0;");
            } else if ( tempBuffer.charAt(i)=='Á' ){
                tempBuffer.replace(i,i+1,"&#x00c1;");
            } else if ( tempBuffer.charAt(i)=='Â' ){
                tempBuffer.replace(i,i+1,"&#x00c2;");
            } else if ( tempBuffer.charAt(i)=='Ã' ){
                tempBuffer.replace(i,i+1,"&#x00c3;");
            } else if ( tempBuffer.charAt(i)=='Ä' ){
                tempBuffer.replace(i,i+1,"&#x00c4;");
            } else if ( tempBuffer.charAt(i)=='Å' ){
                tempBuffer.replace(i,i+1,"&#x00c5;");
            } else if ( tempBuffer.charAt(i)=='Æ' ){
                tempBuffer.replace(i,i+1,"&#x00c6;");
            } else if ( tempBuffer.charAt(i)=='Ç' ){
                tempBuffer.replace(i,i+1,"&#x00c7;");
            } else if ( tempBuffer.charAt(i)=='È' ){
                tempBuffer.replace(i,i+1,"&#x00c8;");
            } else if ( tempBuffer.charAt(i)=='É' ){
                tempBuffer.replace(i,i+1,"&#x00c9;");
            } else if ( tempBuffer.charAt(i)=='Ê' ){
                tempBuffer.replace(i,i+1,"&#x00ca;");
            } else if ( tempBuffer.charAt(i)=='Ë' ){
                tempBuffer.replace(i,i+1,"&#x00cb;");
            } else if ( tempBuffer.charAt(i)=='Ì' ){
                tempBuffer.replace(i,i+1,"&#x00cc;");
            } else if ( tempBuffer.charAt(i)=='Í' ){
                tempBuffer.replace(i,i+1,"&#x00cd;");
            } else if ( tempBuffer.charAt(i)=='Î' ){
                tempBuffer.replace(i,i+1,"&#x00ce;");
            } else if ( tempBuffer.charAt(i)=='Ï' ){
                tempBuffer.replace(i,i+1,"&#x00cf;");
            } else if ( tempBuffer.charAt(i)=='Ð' ){
                tempBuffer.replace(i,i+1,"&#x00d0;");
            } else if ( tempBuffer.charAt(i)=='Ñ' ){
                tempBuffer.replace(i,i+1,"&#x00d1;");
            } else if ( tempBuffer.charAt(i)=='Ò' ){
                tempBuffer.replace(i,i+1,"&#x00d2;");
            } else if ( tempBuffer.charAt(i)=='Ó' ){
                tempBuffer.replace(i,i+1,"&#x00d3;");
            } else if ( tempBuffer.charAt(i)=='Ô' ){
                tempBuffer.replace(i,i+1,"&#x00d4;");
            } else if ( tempBuffer.charAt(i)=='Õ' ){
                tempBuffer.replace(i,i+1,"&#x00d5;");
            } else if ( tempBuffer.charAt(i)=='Ö' ){
                tempBuffer.replace(i,i+1,"&#x00d6;");
            } else if ( tempBuffer.charAt(i)=='×' ){
                tempBuffer.replace(i,i+1,"&#x00d7;");
            } else if ( tempBuffer.charAt(i)=='Ø' ){
                tempBuffer.replace(i,i+1,"&#x00d8;");
            } else if ( tempBuffer.charAt(i)=='Ù' ){
                tempBuffer.replace(i,i+1,"&#x00d9;");
            } else if ( tempBuffer.charAt(i)=='Ú' ){
                tempBuffer.replace(i,i+1,"&#x00da;");
            } else if ( tempBuffer.charAt(i)=='Û' ){
                tempBuffer.replace(i,i+1,"&#x00db;");
            } else if ( tempBuffer.charAt(i)=='Ü' ){
                tempBuffer.replace(i,i+1,"&#x00dc;");
            } else if ( tempBuffer.charAt(i)=='Ý' ){
                tempBuffer.replace(i,i+1,"&#x00dd;");
            } else if ( tempBuffer.charAt(i)=='Þ' ){
                tempBuffer.replace(i,i+1,"&#x00de;");
            } else if ( tempBuffer.charAt(i)=='ß' ){
                tempBuffer.replace(i,i+1,"&#x00df;");
            } else if ( tempBuffer.charAt(i)=='à' ){
                tempBuffer.replace(i,i+1,"&#x00e0;");
            } else if ( tempBuffer.charAt(i)=='á' ){
                tempBuffer.replace(i,i+1,"&#x00e1;");
            } else if ( tempBuffer.charAt(i)=='â' ){
                tempBuffer.replace(i,i+1,"&#x00e2;");
            } else if ( tempBuffer.charAt(i)=='ã' ){
                tempBuffer.replace(i,i+1,"&#x00e3;");
            } else if ( tempBuffer.charAt(i)=='ä' ){
                tempBuffer.replace(i,i+1,"&#x00e4;");
            } else if ( tempBuffer.charAt(i)=='å' ){
                tempBuffer.replace(i,i+1,"&#x00e5;");
            } else if ( tempBuffer.charAt(i)=='æ' ){
                tempBuffer.replace(i,i+1,"&#x00e6;");
            } else if ( tempBuffer.charAt(i)=='ç' ){
                tempBuffer.replace(i,i+1,"&#x00e7;");
            } else if ( tempBuffer.charAt(i)=='è' ){
                tempBuffer.replace(i,i+1,"&#x00e8;");
            } else if ( tempBuffer.charAt(i)=='é' ){
                tempBuffer.replace(i,i+1,"&#x00e9;");
            } else if ( tempBuffer.charAt(i)=='ê' ){
                tempBuffer.replace(i,i+1,"&#x00ea;");
            } else if ( tempBuffer.charAt(i)=='ë' ){
                tempBuffer.replace(i,i+1,"&#x00eb;");
            } else if ( tempBuffer.charAt(i)=='ì' ){
                tempBuffer.replace(i,i+1,"&#x00ec;");
            } else if ( tempBuffer.charAt(i)=='í' ){
                tempBuffer.replace(i,i+1,"&#x00ed;");
            } else if ( tempBuffer.charAt(i)=='î' ){
                tempBuffer.replace(i,i+1,"&#x00ee;");
            } else if ( tempBuffer.charAt(i)=='ï' ){
                tempBuffer.replace(i,i+1,"&#x00ef;");
            } else if ( tempBuffer.charAt(i)=='ð' ){
                tempBuffer.replace(i,i+1,"&#x00f0;");
            } else if ( tempBuffer.charAt(i)=='ñ' ){
                tempBuffer.replace(i,i+1,"&#x00f1;");
            } else if ( tempBuffer.charAt(i)=='ò' ){
                tempBuffer.replace(i,i+1,"&#x00f2;");
            } else if ( tempBuffer.charAt(i)=='ó' ){
                tempBuffer.replace(i,i+1,"&#x00f3;");
            } else if ( tempBuffer.charAt(i)=='ô' ){
                tempBuffer.replace(i,i+1,"&#x00f4;");
            } else if ( tempBuffer.charAt(i)=='õ' ){
                tempBuffer.replace(i,i+1,"&#x00f5;");
            } else if ( tempBuffer.charAt(i)=='ö' ){
                tempBuffer.replace(i,i+1,"&#x00f6;");
            } else if ( tempBuffer.charAt(i)=='÷' ){
                tempBuffer.replace(i,i+1,"&#x00f7;");
            } else if ( tempBuffer.charAt(i)=='ø' ){
                tempBuffer.replace(i,i+1,"&#x00f8;");
            } else if ( tempBuffer.charAt(i)=='ù' ){
                tempBuffer.replace(i,i+1,"&#x00f9;");
            } else if ( tempBuffer.charAt(i)=='ú' ){
                tempBuffer.replace(i,i+1,"&#x00fa;");
            } else if ( tempBuffer.charAt(i)=='û' ){
                tempBuffer.replace(i,i+1,"&#x00fb;");
            } else if ( tempBuffer.charAt(i)=='ü' ){
                tempBuffer.replace(i,i+1,"&#x00fc;");
            } else if ( tempBuffer.charAt(i)=='ý' ){
                tempBuffer.replace(i,i+1,"&#x00fd;");
            } else if ( tempBuffer.charAt(i)=='þ' ){
                tempBuffer.replace(i,i+1,"&#x00fe;");
            } else if ( tempBuffer.charAt(i)=='ÿ' ){
                tempBuffer.replace(i,i+1,"&#x00ff;");
            } else if ( tempBuffer.charAt(i)=='‰' ){
                tempBuffer.replace(i,i+1,"&#x2030;");
            }
        }

        Util.debugLog("string2unicode(), result = " + tempBuffer.toString());
        return tempBuffer.toString();
    }

    /**
     * Replace all occurrences of the characters &, ', ", < and > by the escaped
     * characters &amp;, &quot;, &apos;, &lt; and &gt;
     */
    public static String XMLEscape(String s) {
        if ((s == null) || (s.length() == 0)) {
            return s;
        }

        StringTokenizer tokenizer = new StringTokenizer(s, XML_ESCAPE_DELIMITERS, true);
        StringBuffer    result    = new StringBuffer();

        while (tokenizer.hasMoreElements()) {
            String substring = tokenizer.nextToken();

            if (substring.length() == 1) {
                switch (substring.charAt(0)) {

                //case '&' :
                //    result.append("&amp;");
                //    break;

                case '\'' :
                    result.append("&apos;");
                    break;

                case '<' :
                    result.append("&lt;");
                    break;

                case '>' :
                    result.append("&gt;");
                    break;

                case '\"' :
                    result.append("&quot;");
                    break;

                case '\n' :
                    result.append("\\n");
                    break;

                default :
                    result.append(substring);
                }
            }
            else {
                result.append(substring);
            }
        }

        return result.toString();
    }

    /**
     * Replace all occurrences of the escaped characters &amp;, &quot;, &apos;,
     * &lt; and &gt; by the unescaped characters &, ', ", < and >.
     */
    public static String XMLUnescape(String s) {
        if ((s == null) || (s.length() == 0)) {
            return s;
        }

        int    offset;
        int    next;
        String result;

        // filter out all escaped ampersands
        offset = 0;
        result = "";

        while ((next = s.indexOf("&amp;", offset)) >= 0) {
            result += s.substring(offset, next) + "&";
            offset = next + "&amp;".length();
        }

        result += s.substring(offset, s.length());    // characters after last &
        s      = result;

        // filter out all escaped double quotes
        offset = 0;
        result = "";

        while ((next = s.indexOf("&quot;", offset)) >= 0) {
            result += s.substring(offset, next) + "\"";
            offset = next + "&quot;".length();
        }

        result += s.substring(offset, s.length());    // characters after last "
        s      = result;

        // filter out all escaped single quotes
        offset = 0;
        result = "";

        while ((next = s.indexOf("&apos;", offset)) >= 0) {
            result += s.substring(offset, next) + "\'";
            offset = next + "&apos;".length();
        }

        result += s.substring(offset, s.length());    // characters after last "
        s      = result;

        // filter out all escaped less than characters
        offset = 0;
        result = "";

        while ((next = s.indexOf("&lt;", offset)) >= 0) {
            result += s.substring(offset, next) + "\"";
            offset = next + "&lt;".length();
        }

        result += s.substring(offset, s.length());    // characters after last <
        s      = result;

        // filter out all escaped greater than characters
        offset = 0;
        result = "";

        while ((next = s.indexOf("&gt;", offset)) >= 0) {
            result += s.substring(offset, next) + ">";
            offset = next + "&gt;".length();
        }

        result += s.substring(offset, s.length());    // characters after last >
        s      = result;

        // filter out all escaped newlines
        offset = 0;
        result = "";

        while ((next = s.indexOf("\\n", offset)) >= 0) {
            result += s.substring(offset, next) + "\n";
            offset = next + "\\n".length();
        }

        result += s.substring(offset, s.length());    // characters after last newline

        return result;
    }
}
