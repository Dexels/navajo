<?xml version="1.0" encoding="UTF-8"?>
<tid errorhandler="error">
  <tipi class="dialog" closable="false" h="100" icon="{resource:/tipi/tipi-icon-small.png}"
    maximizable="false" modal="true" name="migrateWindow" resizable="true"
    title="'Ophalen eerste gegevensbestand'" w="400">
    <layout type="border">
      <tipi-instance class="tipi" constraint="center" name="migrateScreen" service="vla/InitMigrateOrganization">
        <layout type="table">
          <tr>
            <td colspan="4" weighty="0">
              <component-instance class="progressbar" name="downloadProgress" orientation="horizontal"/>
            </td>
          </tr>
          <tr>
            <td left="5">
              <component-instance class="label" font="{font:/Arial-12-1}" name="downloadStatus" text="'Druk op start om met de download te beginnen'"/>
            </td>
            <td weightx="0">
              <component-instance class="label" font="{font:/Arial-12-1}" name="downloadedMembers" text="''"/>
            </td>
            <td weightx="0">
              <component-instance class="label" font="{font:/Arial-12-1}" name="sep" text="''"/>
            </td>
            <td weightx="0">
              <component-instance class="label" font="{font:/Arial-12-1}" name="totalMembers" text="''"/>
            </td>
          </tr>
          <tr>
            <td colspan="4" weightx="0" weighty="0">
              <component-instance class="button" name="migrateButton" text="'Start'" tooltip="'Start migratie'">
                <event type="onActionPerformed">
                  <condition>
                    <param name="tipipath" value="tipi://init/desktop/query"/>
                    <param name="expression" value="QueryCertificate('c:/vladb/'+[/Club/ClubIdentifier]+'.keystore', 'kl1p_g31t', [/Club/ClubIdentifier], 'validKeystore') AND QueryCertificate('c:/vladb/'+[/Club/ClubIdentifier]+'.keystore', 'kl1p_g31t', [/Club/ClubIdentifier], 'exists')"/>
                    <action type="setValue">
                      <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadStatus:text}"/>
                      <param name="from" value="'Bezig met migreren stamtabellen'"/>
                    </action>
                    <action type="setValue">
                      <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadProgress:value}"/>
                      <param name="from" value="2"/>
                    </action>
                    <action type="setValue">
                      <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadProgress:indeterminate}"/>
                      <param name="from" value="false"/>
                    </action>
                    <action type="performMethod">
                      <param name="tipipath" value="{tipi://init/desktop/query}"/>
                      <param name="method" value="'vla/InitMigrateCodeTables'"/>
                    </action>
                  </condition>
                  <condition>
                    <param name="tipipath" value="tipi://init/desktop/query"/>
                    <param name="expression" value="QueryCertificate('c:/vladb/'+[/Club/ClubIdentifier]+'.keystore', 'kl1p_g31t', [/Club/ClubIdentifier], 'validKeystore') == false"/>
                    <action type="performTipiMethod">
                      <param name="path" value="{tipi://init/desktop/migrateWindow}"/>
                      <param name="name" value="'dispose'"/>
                    </action>
                    <action type="instantiate">
                      <param name="id" value="'certificateWindow'"/>
                      <param name="name" value="'certificateWindow'"/>
                      <param name="location" value="{component://init/desktop}"/>
                      <param name="force" value="true"/>
                    </action>
                    <action type="performTipiMethod">
                      <param name="path" value="{tipi://init/desktop/certificateWindow}"/>
                      <param name="name" value="'show'"/>
                    </action>
                  </condition>
                </event>
              </component-instance>
            </td>
          </tr>
          <tr>
            <td>
              <component-instance class="hidden" id="hidden1"/>
            </td>
          </tr>
        </layout>
      </tipi-instance>
    </layout>
    <tipi-instance class="messagestore" id="dummy1" name="dummy1"
      service="vla/InitMigrateCodeTables" visible="false">
      <event type="onLoad">
        <action type="setValue">
          <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadStatus:text}"/>
          <param name="from" value="'Bezig met migreren organisatie'"/>
        </action>
        <action type="performMethod">
          <param name="tipipath" value="{tipi://init/desktop/query}"/>
          <param name="method" value="'vla/ProcessMigrateOrganization'"/>
        </action>
      </event>
    </tipi-instance>
    <tipi-instance class="messagestore" id="dummy2" name="dummy2"
      service="vla/ProcessMigrateOrganization" visible="false">
      <event type="onLoad">
        <action type="setValue">
          <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadProgress:value}"/>
          <param name="from" value="4"/>
        </action>
        <action type="setValue">
          <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadStatus:text}"/>
          <param name="from" value="'Bezig met migreren leden'"/>
        </action>
        <action type="performMethod">
          <param name="tipipath" value="{tipi://init/desktop/query}"/>
          <param name="method" value="'vla/ProcessMigrateMembers'"/>
        </action>
      </event>
    </tipi-instance>
    <tipi-instance class="messagestore" id="dummy3" name="dummy3"
      service="vla/ProcessMigrateMembers" visible="false">
      <event type="onLoad">
        <condition>
          <param name="tipipath" value="tipi:/."/>
          <param name="expression" value="[/Result/HasMore] == true"/>
          <action type="setValue">
            <param name="from" value="{property:/.:.:/Result/NextStartIndex}"/>
            <param name="to" value="{propertyref://init/desktop/query:.:/Club/StartIndex}"/>
          </action>
          <action type="setValue">
            <param name="from" value="{property:/.:.:/Result/NextEndIndex}"/>
            <param name="to" value="{propertyref://init/desktop/query:.:/Club/EndIndex}"/>
          </action>
          <action type="setValue">
            <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/sep:text}"/>
            <param name="from" value="' van de '"/>
          </action>
          <action type="setValue">
            <param name="from" value="{property://init/desktop/migrateWindow/dummy3:.:/Result/Progress}"/>
            <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadProgress:value}"/>
          </action>
          <action type="setValue">
            <param name="from" value="{property://init/desktop/query:.:/Club/StartIndex}"/>
            <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadedMembers:text}"/>
          </action>
          <action type="setValue">
            <param name="from" value="{property://init/desktop/migrateWindow/dummy3:.:/Result/TotalMembers}"/>
            <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/totalMembers:text}"/>
          </action>
          <action type="performMethod">
            <param name="tipipath" value="{tipi://init/desktop/query}"/>
            <param name="method" value="'vla/ProcessMigrateMembers'"/>
          </action>
        </condition>
        <condition>
          <param name="tipipath" value="tipi:/."/>
          <param name="expression" value="[/Result/HasMore] == false"/>
          <action type="setValue">
            <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadProgress:value}"/>
            <param name="from" value="100"/>
          </action>
          <action type="debug">
            <param name="value" value="'before'"/>
          </action>
          <action type="setValue">
            <param name="to" value="{propertyref://init/desktop/query:.:/Club/EndIndex}"/>
            <param name="from" value="50"/>
          </action>
          <action type="debug">
            <param name="value" value="'after'"/>
          </action>
          <action type="setValue">
            <param name="from" value="{property://init/desktop/migrateWindow/dummy3:.:/Result/TotalMembers}"/>
            <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadedMembers:text}"/>
          </action>
          <action type="setValue">
            <param name="from" value="{property://init/desktop/migrateWindow/dummy3:.:/Result/TotalMembers}"/>
            <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/totalMembers:text}"/>
          </action>
          <action type="setValue">
            <param name="to" value="{propertyref://init/desktop/query:.:/Club/StartIndex}"/>
            <param name="from" value="0"/>
          </action>
          <action type="setValue">
            <param name="to" value="{attributeref://init/desktop/migrateWindow/migrateScreen/downloadStatus:text}"/>
            <param name="from" value="'Gereed, leden worden ingeladen'"/>
          </action>
          <action type="performMethod">
            <param name="tipipath" value="{tipi://init/messagestore}"/>
            <param name="method" value="'vla/InitVLASearchMembers'"/>
          </action>
        </condition>
      </event>
    </tipi-instance>
    <tipi-instance class="messagestore" id="dummy4" name="dummy4" service="vla/InitVLASearchMembers" visible="false">
      <event type="onLoad">
        <action type="dispose">
          <param name="path" value="{tipi://init/disclaimcheck}"/>
        </action>
        <action type="performMethod">
          <param name="method" value="'InitVLAAAP'"/>
        </action>
        <action type="setValue">
          <param name="from" value="{property://init/messagestore:.:/Club/ClubIdentifier}"/>
          <param name="to" value="{propertyref://init/desktop/migrateWindow/dummy4:.:/Club/ClubIdentifier}"/>
        </action>
        <action type="performMethod">
          <param name="tipipath" value="{tipi://init/desktop/migrateWindow/dummy4}"/>
          <param name="method" value="'vla/ProcessVLASearchMembers'"/>
        </action>
      </event>
    </tipi-instance>
    <tipi-instance class="messagestore" id="dummy5" name="dummy5"
      service="vla/ProcessVLASearchMembers" visible="false">
      <event type="onLoad">
        <action type="debug">
          <param name="value" value="'DISPOSING MIGRATEWINDOW!!!!!!!!!!!!!'"/>
        </action>
        <action type="performMethod">
          <param name="tipipath" value="{tipi://init/desktop/query}"/>
          <param name="method" value="'vla/ProcessVLAQueryContributionProfiles'"/>
        </action>
        <action type="performTipiMethod">
          <param name="path" value="{tipi://init/desktop/migrateWindow}"/>
          <param name="name" value="'dispose'"/>
        </action>
      </event>
    </tipi-instance>
  </tipi>
</tid>
