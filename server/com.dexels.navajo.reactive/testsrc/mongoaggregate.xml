<reactive array="Aggregate">
	<source.mongo resource="dummyaaa" collection="User" operation="aggregate" debug="true">
		<param name="query">[
				{"$unwind":"$applications"},
				{"$match":{"applications.type":"VOETBALNL","activated":true,"applications.publicuserid":{"$ne":""}}},
				{"$project":{"UserId":"$userid","username":"$username"}},{"$sort":{"userid":1}}
				]
		</param>
 		<msg.mergeSingle.msg>
			<source.mongo resource="dummy" collection="Person" operation="find">
				<param name="query">{"UnionMembership.relationstart":{"$lte":ISODate()},"UnionMembership.relationend":{"$gte":ISODate()},"Communication.Email":"?"}</param>
				<parameval>[username]</parameval>
				<msg.first.singlemessage/>				
			</source.mongo>
			<joiner>
				<toSubMessage name="PersonData"/>
			</joiner>
		</msg.mergeSingle.msg>
		<msg.mergeSingle.msg>
			<source.mongo resource="dummyexternalstore" collection="AccountAttribute" operation="find">
				<param name="query">{"UserId":"?"}</param>
				<parameval>[UserId]</parameval>
			</source.mongo>
			<reducer>
				<set>
					<parameval name="to">[Key]</parameval>
					<parameval name="value">[Value]</parameval>
				</set>
			</reducer>
			<joiner>
				<toSubMessage name="Attributes"/>
			</joiner>
		</msg.mergeSingle.msg>
	</source.mongo>
</reactive>