<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
<!-- title and meta -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Navajo Tester v2</title>

<!-- css -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu:300,400,700,400italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Oswald:400,300,700' rel='stylesheet' type='text/css'>
<link href="css/navajotester.css" rel="stylesheet" />

<!-- js -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js" type="text/javascript">
    
</script>
<script src="js/dexels/navi.js" type="text/javascript"></script>
<script src="js/handlebars-v3.0.3.js" type="text/javascript"></script>
</head>

<script id="scripts-template" type="text/x-handlebars-template">
<h2 class="title"> Folders and scripts </h2>
<ul class="scripts">
    {{#each this}} 
		{{#equals this.type 'FOLDER'}}
 			<li> <div class="folder" id="{{path}}"> {{name}} </div> </li> 
	 	{{else}}
			 <li> <div class="script" id="{{path}}"> {{name}} </div>  </li>
		{{/equals}}
       
        
    {{/each}}
 </ul>
</script>

<script id="folder-template" type="text/x-handlebars-template">

<ul class="scripts">
    {{#each this}} 
        {{#equals this.type 'FOLDER'}}
            <li> <div class="folder" id="{{path}}" > {{name}} </div> </li> 
        {{else}}
             <li> <div class="script" id="{{path}}"> {{name}} </div>  </li>
        {{/equals}}
       
        
    {{/each}}
 </ul>
</script>

<script>
Array.prototype.indexOfPath = function(path) {
    for (var i = 0; i < this.length; i++)
        if (this[i].path === path)
            return i;
    return -1;
}

	$(document).ready(
            function() {
                
                Handlebars.registerHelper('equals', function(v1, v2, options) {
                    if(v1 === v2) {
                        return options.fn(this);
                      }
                      return options.inverse(this);
                });
                
            
               	getScripts();
               	
            });

    function getScripts() {
        var scriptssource = $("#scripts-template").html();
        var scriptstemplate = Handlebars.compile(scriptssource);
        
        var foldersource = $("#folder-template").html();
        var foldertemplate = Handlebars.compile(foldersource);
        
        $.getJSON("/testerapi?query=getscripts", function(data) {
            data.sort(function(a, b) {
            	return a.name.localeCompare(b.name);
        	});
            $("#scripts").html(scriptstemplate(data));
            $(document).on('click', '.script', function(){
                window.alert('Going to run: ' +  $( this ).text());
            });
            $(document).on('click', '.folder', function(e){ 
                if ($(this).children().length > 0 ) {
                   $(this).children().remove();
                } else {
                    // Find higest element
                    var entries = getMyEntries(data, $(this))
                    $( this ).append(foldertemplate(entries));
                }
                e.stopPropagation();
            });

        });
        
       
    };
    
    function getMyEntries(data, element) {
      	if (element.parents('.folder').length < 1) {
      	  	var itemsIndex = data.indexOfPath(element.attr('id'));
          	var subEntries = data[itemsIndex].entries;
          	subEntries.sort(function(a, b) {
          		return a.name.localeCompare(b.name);
      		});
          	return subEntries;
      	} else {
      	    // Find my parents entries and check him
      	    var myParent = element.parents('.folder').first();
      	    var myParentEntries = getMyEntries(data, myParent);
      	    var itemsIndex = myParentEntries.indexOfPath(element.attr('id'));
        	var subEntries = myParentEntries[itemsIndex].entries;
        	subEntries.sort(function(a, b) {
        		return a.name.localeCompare(b.name);
    		});
        	return subEntries;
        	
      	}
    };
</script>
<body>

    <div id="wrapper">
        <header>
            <div id="title" class="container">
                <h1>Navajo Tester v2</h1>
            </div>

        </header>
        <!-- /header -->


        <div id="main">
            <div class="container">
                <!-- 				<nav id="nav-main"> -->
                <!-- 					<ul class="nav-class"> -->
                <!-- 						<li id="lihome" class="open" ><a href="index.html">Home</a></li> -->
                <!-- 						<li id="lialerts"><a href="alerts.html">Alerts</a></li> -->
                <!-- 					</ul> -->
                <!-- 				</nav> -->
            </div>
           
            <div id="content" class="content">
               
                <div id="scripts" class="scriptsbar">
                    abc <br/>
                    def
                </div>
                
                 <div id="mainview" class="mainview">
                
                </div>
                

            </div>

        </div>
        <!-- #main -->
    </div>
    <!-- /#wrapper -->

</body>
</html>