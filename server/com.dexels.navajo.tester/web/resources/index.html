<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
<!-- title and meta -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Navajo Tester v2</title>

<!-- css -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu:300,400,700,400italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Oswald:400,300,700' rel='stylesheet' type='text/css'>
<link href="css/navajotester.css" rel="stylesheet" />

<!-- js -->
<!-- <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?autoload=true&amp;lang=css" defer="defer"></script> -->
<link href="/css/prettify.css" type="text/css" rel="stylesheet" />
<script type="text/javascript" src="/js/prettify.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js" type="text/javascript"></script>
<script src="js/dexels/navi.js" type="text/javascript"></script>
<script src="js/handlebars-v3.0.3.js" type="text/javascript"></script>
</head>

<script id="scripts-template" type="text/x-handlebars-template">
<h2 class="title"> Folders and scripts </h2>
<input id="scriptsFilter" type="text" />
<ul class="scripts">
    {{#each this}} 
		{{#equals this.type 'FOLDER'}}
 			<li> <div class="folder" id="{{path}}"> {{name}} </div> 
				{{> subscripts this }}
			</li> 
	 	{{else}}
			 <li> <div class="script" id="{{path}}"> {{name}} </div>  </li>
		{{/equals}}
       
        
    {{/each}}
 </ul>
</script>

<script id="folder-template" type="text/x-handlebars-template">
<ul >
    {{#each this.entries}} 
        {{#equals this.type 'FOLDER'}}
            <li style="display: none"> <div class="folder" id="{{path}}" > {{name}} </div> 
				{{> subscripts this }}
			</li> 
        {{else}}
             <li style="display: none"> <div class="script" id="{{path}}"> {{name}} </div>  </li>
        {{/equals}}
       
        
    {{/each}}
 </ul>
</script>

<script>
    Array.prototype.indexOfPath = function(path) {
        for (var i = 0; i < this.length; i++)
            if (this[i].path === path)
                return i;
        return -1;
    }

	$(document).ready(
            function() {
                
                Handlebars.registerHelper('equals', function(v1, v2, options) {
                    if(v1 === v2) {
                        return options.fn(this);
                      }
                      return options.inverse(this);
                });
               	getScripts();
            }
    );
	

    function getScripts() {
        var scriptssource = $("#scripts-template").html();
        var scriptstemplate = Handlebars.compile(scriptssource);
        
        var foldersource = $("#folder-template").html();
        var foldertemplate = Handlebars.compile(foldersource);
        
        Handlebars.registerPartial('subscripts', foldertemplate);
        
        $.getJSON("/testerapi?query=getscripts", function(data) {
            data.sort(function(a, b) {
            	return a.name.localeCompare(b.name);
        	});
            $("#scripts").html(scriptstemplate(data));
            $(document).on('click', '.script', function(){
                getFileContent($( this ).attr('id'));
            });
            
//             $(document).on('click', '.folder', function(e){ 
//                 if ($(this).children().length > 0 ) {
//                    $(this).children().remove();
//                 } else {
//                     // Find higest element
//                     var entries = getMyEntries(data, $(this))
//                     $( this ).append(foldertemplate(entries));
//                 }
//                 e.stopPropagation();
//             });
            
            $(document).on("change", "#scriptsFilter", function(e){  
                var filter = $(this).val();
                updateVisibility(filter, $(".scripts"))
            });

        });
        
       
    };
    
    function getFileContent(fileid) {
        $.get("/testerapi?query=getfilecontent&file=" + fileid, function(data) {
            $('#scriptcontent').removeClass('prettyprinted');
            $('#scriptcontent').text(data)
     		prettyPrint();
            $('html, body').animate({scrollTop:0}, 'slow');
        });
    }
    
    function updateVisibility(filter, element) {
        var anyMatch = false;
       
        element.children('li').each(function() {
            var scriptid = $( this ).children('div').first().attr('id');
            var className = $( this ).children('div').first().attr('class');

            var match = scriptid.search(new RegExp(filter, "i"));
			var isFolder = className === 'folder';
			
			if (isFolder) {
			    var childHasMatches = updateVisibility(filter,  $( this ).children('ul').first());
                if (childHasMatches) {
                    $(this).show()
                    anyMatch = true;
                } else {
                    $(this).hide()
                }
                
			} else {
			    if (match < 0) {
			        $(this).hide()
			    } else {
			        $(this).show()
			        anyMatch = true;
			    }
			}
        });
        return anyMatch;
    }
    
  
    function getMyEntries(data, element) {
      	if (element.parents('.folder').length < 1) {
      	  	var itemsIndex = data.indexOfPath(element.attr('id'));
          	var subEntries = data[itemsIndex].entries;
          	subEntries.sort(function(a, b) {
          		return a.name.localeCompare(b.name);
      		});
          	return subEntries;
      	} else {
      	    // Find my parents entries and check him
      	    var myParent = element.parents('.folder').first();
      	    var myParentEntries = getMyEntries(data, myParent);
      	    var itemsIndex = myParentEntries.indexOfPath(element.attr('id'));
        	var subEntries = myParentEntries[itemsIndex].entries;
        	subEntries.sort(function(a, b) {
        		return a.name.localeCompare(b.name);
    		});
        	return subEntries;
        	
      	}
    };
</script>
<body>

    <div id="wrapper">
        <header>
            <div id="title" class="container">
                <h1>Navajo Tester v2</h1>
            </div>

        </header>
        <!-- /header -->


        <div id="main">
            <div class="container">
                <!-- 				<nav id="nav-main"> -->
                <!-- 					<ul class="nav-class"> -->
                <!-- 						<li id="lihome" class="open" ><a href="index.html">Home</a></li> -->
                <!-- 						<li id="lialerts"><a href="alerts.html">Alerts</a></li> -->
                <!-- 					</ul> -->
                <!-- 				</nav> -->
            </div>
           
            <div id="content" class="content">
               
                <div id="scripts" class="scriptsbar">
                    
                </div>
                
                 <div id="mainview" class="mainview">
                    <pre id="scriptcontent" class="prettyprint lang-xml">
                    
                    </pre>
                </div>
                

            </div>

        </div>
        <!-- #main -->
    </div>
    <!-- /#wrapper -->

</body>
</html>