<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
	<link href="css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
	<link href="css/docs.css" rel="stylesheet" media="screen">
</head>
<body>
	<script src="js/jquery-1.9.1.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/purl.js"></script>
	<script src="js/handlebars.js"></script>

	<div id="main" style="margin:10px 10px;">
		<div class="page-header">
			<h1>Tipi Application Store <small>(handle with care)</small></h1>
		</div>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="alert alert-info resultmsg"></div>
</nav>

	<script id="some-template" type="text/x-handlebars-template">
        {{#each applications}} 
		<div class="panel panel-primary application" style="margin:30px 0px;">
			<div class="panel-heading">
				<h2 class="panel-title"><a href="{{httpUrl}}/tree/{{branch}}">{{@key}} - {{branch}}</a></h2>
			</div>
			<div class="panel-body">
				<p>Current version: <a href="{{httpUrl}}/commit/{{lastCommitVersion}}">{{lastCommitVersion}}</a> </p>
				<p>Message: {{lastCommitMessage}}</p>
				<p>Date: {{lastCommitDate}}</p>
				<p>Author: <a href="https://github.com/{{lastCommitAuthor}}">{{lastCommitAuthor}}</a></p>
				<form>
					{{#each profileStatus}}
						<a href="../apps/{{../applicationName}}/{{@key}}.jnlp" class="{{classForStatus this}}">{{@key}}</a>
					{{/each}}
					<p>Checkout: <input type="text" class="form-control"> branch: <input type="text" class="form-control">
					</p>
					<button type="submit" class="btn btn-default">Checkout</button>
				</form>
			</div>
			<div class="panel-group" id="accordion">
				<div class="panel panel-default">
					<div class="panel-heading">
						<h4 class="panel-title">
							<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
								Dependencies
							</a>
						</h4>
					</div>
					<div id="collapseOne" class="panel-collapse collapse">
						<div class="panel-body">
							<ul>
								{{#each dependencies}}
									<li><a href="#">{{fileName}}</a></li>
								{{/each}}
							</ul>
						</div>
					</div>
				</div>
			<div>
			<div class="panel-footer">
				<div class="btn-group">
					<button id="{{@key}}_pull" type="button" name="pull" value="{{@key}}" class="btn btn-default pullbutton {{@key}}">Pull</button>
					<button id="{{@key}}_clean" type="button" name="clean" value="{{@key}}" class="btn btn-default">Clean</button>
					<button id="{{@key}}_buildjnlp" type="button" name="build" value="{{@key}}" class="btn btn-default">Build JNLP</button>
					<button id="{{@key}}_cache" type="button" name="cachebuild" value="{{@key}}" class="btn btn-default">Build cache</button>
					<button id="{{@key}}_xsd" type="button" name="xsd" value="{{@key}}" class="btn btn-default">Build xsd</button>
				</div>
			</div>
		</div>
		</div>
		</div>
        {{/each}} 
	</div>

	</script>
	</div>

		<script type="text/javascript">
		
			Handlebars.registerHelper('classForStatus', function (status, options) {
				if(status=='OK') {
					return "btn btn-success";
				}
				if(status=='OUTDATED') {
					return "btn btn-warning";
				}
				return "btn btn-danger";
			});
			function loadApplicationData() {

				$.getJSON('../list', function(data) {
					$( ".application" ).remove();
					var source = $("#some-template").html(); 
					var template = Handlebars.compile(source); 
					$('#main').append(template(data));
					console.log(template(data));
				});
			}

	loadApplicationData();
	$(document).on("click", ".btn-default", function(a ){
	var url = "../"+this.name+"?app="+this.value;
/* 	$.get(url,function( data ) {
		$( ".resultmsg" ).html( data );
		loadApplicationData();

	}); */
	  $.ajax({
		    type: 'GET',
		    dataType: 'json',
		    url: url,
		    timeout: 15000,
		    success: function(data, textStatus ){
				$( ".resultmsg" ).html( data );
				loadApplicationData();
		    },
		    error: function(xhr, textStatus, errorThrown){
				$( ".resultmsg" ).html( errorThrown );
		       alert('request failed');
		    }
		  });
});
		</script>

	</body>
</html>