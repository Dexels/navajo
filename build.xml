<?xml version="1.0" encoding="UTF-8" ?>
<!-- $Id$ -->

<project name="NavajoServer" default="all" basedir=".">
	<property file="build.properties" />
	<taskdef name="deploy" classname="org.apache.catalina.ant.DeployTask" />
	<taskdef name="undeploy" classname="org.apache.catalina.ant.UndeployTask" />
	<taskdef name="start" classname="org.apache.catalina.ant.StartTask" />

	<property name="tar.archive" value="NavajoServer.tgz" />
	<property name="zip.archive" value="NavajoServer.zip" />
	<property name="war.archive" value="NavajoServer.war" />

	<property name="classes" value="classes" />

	<property name="navajoTomcatServerManager" value="${navajoTomcatServer}/manager" />
	
	
	<property name="enterprisetar.archive" value="NavajoEnterprise.tgz" />
	<property name="enterprisezip.archive" value="NavajoEnterprise.zip" />
	<property name="enterprisewar.archive" value="NavajoEnterprise.war" />

	<property name="publish.dir" value="publish" />
	<property name="enterprisepublish.dir" value="enterprisepublish" />
	<property name="dist.dir" value="dist" />
	<property name="enterprisedist.dir" value="enterprisedist" />

	<property name="sourcetar.archive" value="NavajoServerSource.tgz" />
	<property name="sourcezip.archive" value="NavajoServerSource.zip" />
	<property name="deployRoot" value="${navajoScpUser}@${navajoScpServer}:${navajoScpPath}" />
	<delete dir="source/" />

	<copy todir="source">
		<fileset file="sourcebuild.xml">
		</fileset>
	</copy>
	<copy todir="source/NavajoEnterprise">
		<fileset dir="../Navajo/src">

			<!-- enterprise -->
			<include name="com/dexels/navajo/scheduler/**" />
			<include name="com/dexels/navajo/tribe/**" />
			<include name="com/dexels/navajo/workflow/**" />
			<include name="com/dexels/navajo/adapter/**" />
			<include name="com/dexels/navajo/integrity/**" />
			<include name="com/dexels/navajo/jabber/**" />
			<include name="com/dexels/navajo/server/descriptionprovider/**" />
			<include name="com/dexels/navajo/server/statistics/**" />
			<include name="com/dexels/navajo/server/monitoring/**" />

		</fileset>
	</copy>

	<copy todir="source/Navajo">
		<fileset dir="../Navajo/src">
			<include name="**/*" />

			<!-- enterprise -->
			<exclude name="com/dexels/navajo/scheduler/**" />
			<exclude name="com/dexels/navajo/tribe/**" />
			<exclude name="com/dexels/navajo/workflow/**" />
			<exclude name="com/dexels/navajo/adapter/**" />
			<exclude name="com/dexels/navajo/integrity/**" />
			<exclude name="com/dexels/navajo/jabber/**" />
			<exclude name="com/dexels/navajo/server/descriptionprovider/**" />
			<exclude name="com/dexels/navajo/server/statistics/**" />
			<exclude name="com/dexels/navajo/server/monitoring/**" />

			<exclude name="**/*.jjt" />
			<exclude name="**/*.bat" />

		</fileset>

	</copy>

	<copy todir="source/NavajoDocument">
		<fileset dir="../NavajoDocument/src" />
	</copy>
	<copy todir="source/NavajoClient">
		<fileset dir="../NavajoClient/src" />
	</copy>
	<copy todir="source/NavajoListeners">
		<fileset dir="../NavajoListeners/src">
			<exclude name="com/dexels/navajo/server/listener/http/LaszloUploadServlet.java" />
			<exclude name="com/dexels/navajo/server/listener/soap/**" />
			<exclude name="com/dexels/navajo/server/listener/smtp/**" />
			<exclude name="com/dexels/navajo/server/listener/wsdl/**" />
		</fileset>
	</copy>
	<copy todir="source/NavajoFunctions">
		<fileset dir="../NavajoFunctions/src">
			<exclude name="com/dexels/navajo/functions/ExistsWorkflow.java" />
		</fileset>
	</copy>
	<copy todir="source/NavajoAdapters">
		<fileset dir="../NavajoAdapters/src">
			<exclude name="com/dexels/navajo/adapter/descriptionprovider/**" />
			<exclude name="com/dexels/navajo/adapter/ibatis/**" />
			<exclude name="com/dexels/navajo/adapter/icalmap/**" />
			<exclude name="com/dexels/navajo/adapter/ldap/**" />
			<exclude name="com/dexels/navajo/adapter/poi/**" />
			<exclude name="com/dexels/navajo/adapter/rss/**" />
			<exclude name="com/dexels/navajo/adapter/navajostore/**" />
			<exclude name="com/dexels/navajo/adapter/SheetMap.java" />
			<exclude name="com/dexels/navajo/adapter/JabberBroadcastMap.java" />
			<exclude name="com/dexels/navajo/adapter/BabelFishMap.java" />
			<exclude name="com/dexels/navajo/adapter/FTPMap.java" />
			<exclude name="com/dexels/navajo/adapter/ICalMap.java" />
			<exclude name="com/dexels/navajo/adapter/OracleAdministratorMap.java" />
			<exclude name="com/dexels/navajo/adapter/RSSMap.java" />
			<exclude name="com/dexels/navajo/adapter/NavajoMap.java" />
			<exclude name="com/dexels/navajo/adapter/VersionedNavajoMap.java" />
			<exclude name="com/dexels/navajo/adapter/SOAPMap.java" />
			<exclude name="com/dexels/navajo/adapter/SPMap.java" />
			<exclude name="com/dexels/navajo/adapter/MultipleSQLMap.java" />
			<exclude name="com/dexels/navajo/adapter/html/**" />
		</fileset>
	</copy>
	
	
	
	<copy todir="source/DexelsVersionControl">
		<fileset dir="../DexelsVersionControl/src" />
	</copy>
	<target name="clean">
		<delete dir="WEB-INF/lib">
			<include name="*.jar" />
		</delete>
		<delete dir="${dist.dir}" />
		<delete dir="enterprisedist" />
		<delete dir="${publish.dir}" />
		<delete dir="${enterprisepublish.dir}" />
		<delete file="${classes}/**"/>
	</target>


	<target name="tar" depends="compile">
		<tar tarfile="${publish.dir}/${tar.archive}" longfile="gnu" basedir="${dist.dir}">
		</tar>
	</target>
	<target name="war" depends="compile">
		<war destfile="${publish.dir}/${war.archive}" basedir="${dist.dir}" webxml="dist/WEB-INF/web.xml">
		</war>
	</target>
	<target name="zip" depends="compile">
		<zip zipfile="${publish.dir}/${zip.archive}" basedir="${dist.dir}">
		</zip>
	</target>

	<target name="enterprisewar" depends="compile">
		<mkdir dir="${enterprisepublish.dir}" />
		<copy todir="${enterprisepublish.dir}">
			<fileset file="dist/**" />
		</copy>
		<copy todir="${enterprisepublish.dir}/WEB-INF/lib">
			<fileset file="${enterprisedist.dir}/lib/*.jar" />
			<fileset file="${enterprisedist.dir}/NavajoEnterpriseExtension.jar" />
		</copy>
		<copy todir="${enterprisepublish.dir}" overwrite="true">
			<fileset file="sample_enterprise/**" />
		</copy>



		<war destfile="${publish.dir}/${enterprisewar.archive}" basedir="${enterprisepublish.dir}" webxml="${dist.dir}/WEB-INF/web.xml">
		</war>
	</target>


	<target name="enterprisezip" depends="compile">
		<zip zipfile="${publish.dir}/${enterprisezip.archive}" basedir="${enterprisedist.dir}">
		</zip>
	</target>

	<target name="enterprisetar" depends="compile">
		<tar tarfile="${publish.dir}/${enterprisetar.archive}" longfile="gnu" basedir="${enterprisedist.dir}">
		</tar>
	</target>

	<target name="sourcetar">
		<tar tarfile="${publish.dir}/${sourcetar.archive}" basedir="source">
		</tar>
	</target>
	<target name="sourcezip">
		<zip zipfile="${publish.dir}/${sourcezip.archive}" basedir="source">
		</zip>
	</target>




	<target name="grab" depends="clean">

		<mkdir dir="${publish.dir}" />

		<copy todir="${dist.dir}/WEB-INF/lib">
			<fileset file="3rdparty/*.jar">
				<exclude name="servlet**" />
			</fileset>
			<fileset file="sample/3rdparty/**" />
		</copy>
		<copy todir="enterprisedist/lib">

			<fileset file="3rdparty/enterprise/*.jar">
				<exclude name="servlet**" />
			</fileset>

		</copy>

		<copy todir="${dist.dir}/WEB-INF">
			<fileset file="sample/WEB-INF/web.xml" />
		</copy>
		<copy todir="${dist.dir}/config">
			<fileset file="sample/config/**" />
		</copy>
		<copy todir="${dist.dir}/adapters">
			<fileset file="sample/adapters/*.jar" />
		</copy>
		<copy todir="${dist.dir}/scripts">
			<fileset file="sample/scripts/**" />
		</copy>
		<copy todir="${dist.dir}/resource">
			<fileset file="sample/resource/**" />
		</copy>
		<copy todir="${dist.dir}/resource">
			<fileset file="resource/**" />
		</copy>
		<copy todir="${dist.dir}/">
			<fileset file="sample/index.html" />
			<fileset file="sample/logo-dexels.gif" />
		</copy>
	</target>
	<target name="compile" depends="grab">
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${dist.dir}/WEB-INF" />
		<mkdir dir="${dist.dir}/WEB-INF/lib" />
		<ant antfile="sourcebuild.xml" dir="." />
		<ant antfile="enterprisebuild.xml" dir="." />
	</target>

	<target name="sourcebuild" depends="sourcezip,sourcetar" />
	<target name="binarybuild" depends="war,tar,zip,enterprisewar,enterprisetar,enterprisezip" />


	<target name="archive" depends="binarybuild,sourcebuild" />

 
	<target name="publish" depends="archive">
		<echo message="${deployRoot}" />
		<scp trust="true" sftp="true" verbose="true" password="${navajoScpPassword}" todir="${deployRoot}">
			<fileset dir="${publish.dir}">
				<include name="**" />
			</fileset>
		</scp>
	</target>
	<target name="deploy" depends="archive">
		<echo message="${navajoTomcatServer}${navajoTomcatContext}${navajoServletPath}${navajoTesterCommand}"/>
		<deploy url="${navajoTomcatServerManager}" update="true" username="${navajoTomcatUser}" password="${navajoTomcatPassword}" path="${navajoTomcatContext}" war="${publish.dir}/${war.archive}" />
		<deploy url="${navajoTomcatServerManager}" update="true" username="${navajoTomcatUser}" password="${navajoTomcatPassword}" path="${navajoTomcatEnterpriseContext}" war="${publish.dir}/${enterprisewar.archive}" />
		<get dest="classes/temp" src="${navajoTomcatServer}${navajoTomcatContext}${navajoServletPath}${navajoTesterCommand}"/>
		<get dest="classes/temp" src="${navajoTomcatServer}${navajoTomcatEnterpriseContext}${navajoServletPath}${navajoTesterCommand}"/>
	</target> 

	<target name="all" depends="publish,deploy" />

</project>
<!-- EOF: $RCSfile$ -->
