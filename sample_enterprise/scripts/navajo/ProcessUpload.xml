<?xml version="1.0" encoding="UTF-8"?>
<tsl author="Arjen Schoneveld" xmlns="http://www.dexels.com/navascript" id="navajo/ProcessUpload" repository="$Id$" notes="Script for uploading adapters and scripts. Support CVS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.dexels.com/navascript http://www.dexels.nl/schema/navascript.xsd">
    <map object="com.dexels.navajo.adapter.AdminMap">
        <param direction="out" name="Path">
            <expression value="$adapterPath" condition="[/FileInfo/FileType] == 'ADAPTER'"/>
            <expression value="$scriptPath"/>
        </param>
    </map>
    <map object="com.dexels.navajo.adapter.FileMap">
        <field name="fileName">
            <expression value="[/@Path] + '/' + [/FileInfo/FileName]"/>
        </field>
        <param name="FileExists">
            <expression value="$exists"/>
        </param>
        <debug value="'File exists: ' + $exists"/>
        <field name="content">
            <expression value="[/FileInfo/FileContent]"/>
        </field>
    </map>
    <!-- Check for existing file -->
    <map object="com.dexels.navajo.adapter.RuntimeAdapter" condition="[/FileInfo/UseCVS] == true">
        <field name="dir">
            <expression value="[/@Path]"/>
        </field>
        <param name="StickyOptions">
            <expression value="'-kb '" condition="[/FileInfo/FileType] == 'ADAPTER'"/>
            <expression value="''"/>
        </param>
        <param name="DeSpacedComment">
            <expression value="StringFunction('replaceAll', [/FileInfo/CVSComment], ' ', '_')"/>
        </param>
        <field name="script">
            <expression condition="[/@FileExists] == false" value="'cvs add ' + [/@StickyOptions] + '-m ' + [/@DeSpacedComment] + ' ' + [/FileInfo/FileName] + ';cvs commit -m ' + [/@DeSpacedComment]"/>
            <expression value="'cvs commit -m ' + [/@DeSpacedComment]"/>
        </field>
        <field name="run">
            <expression value="true"/>
        </field>
    </map>
    <map object="com.dexels.navajo.adapter.RuntimeAdapter" condition="[/FileInfo/UseCVS] == true">
        <!-- Get version info for file -->
        <field name="dir">
            <expression value="[/@Path]"/>
        </field>
        <field name="script">
            <expression value="'cvs status ' + [/FileInfo/FileName]"/>
        </field>
        <field name="run">
            <expression value="true"/>
        </field>
        <param name="CVSStatus">
            <expression value="$output"/>
        </param>
    </map>
    <!-- Reset adapters adapter jar was uploaded -->
    <map object="com.dexels.navajo.adapter.AdminMap" condition="[/FileInfo/FileType] == 'ADAPTER'">
        <field name="resetAdapters">
            <expression value="true"/>
        </field>
    </map>
    <message name="Saved">
        <property name="FileName" direction="out">
            <expression value="[/@Path] + '/' + [/FileInfo/FileName]"/>
        </property>
        <property name="CVSStatus" direction="out" condition="?[/@CVSStatus]">
            <expression value="ToMemo([/@CVSStatus])"/>
        </property>
    </message>
</tsl>
