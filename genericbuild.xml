<?xml version="1.0" encoding="UTF-8" ?>
<!-- $Id$ -->
<project default="publish">

	<taskdef name="buildExtension" classname="com.dexels.navajo.tipi.ant.extensionbuilder.BuildExtensionTask" classpath="bin" />
	<taskdef name="buildDocumentation" classname="com.dexels.navajo.tipi.ant.extensionbuilder.BuildExtensionDocumentationTask" classpath="bin" />
	<taskdef name="p200ant" classname="de.matthiasmann.p200ant.P200AntTask" classpath="p200ant.jar"/>
	<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
	<taskdef name="for" classname="net.sf.antcontrib.logic.ForTask" onerror="ignore" />
	<property name="tipiSvnUrl" value="http://spiritus.dexels.nl:41766/svn/repos" />
	<property name="repository" value="http://spiritus.dexels.nl:41766/Tipi/" />
	<property name="repositorySsh" value="navajo@spiritus.dexels.nl://var/www/html/Tipi/" />
	<property name="documentationSsh" value="navajo@spiritus.dexels.nl:/var/www/html/Tipi/wiki/data/pages/tipidoc" />
	
	<target name="prepare">
		<echo message="Java version: ${java.version}"/>
		<taskdef name="retrieveVersion" classname="com.dexels.navajo.tipi.ant.extensionbuilder.RetrieveVersion" classpath="bin" />
		<retrieveVersion />
		<property name="dist" value="dist/${ant.project.name}/${tipiComponentVersion}" />
		<!--  clean -->
	</target>

	<target name="grabjars" depends="prepare">
		<mkdir dir="${dist}/lib" />
		<echo message="Extra deployment jars: ${tipiDeployedDependencyJars}"/>
		<!-- TODO Create custom task to only copy the files referenced in the extension definition -->
		<copy todir="${dist}/lib">
			<fileset dir="lib">
				<include name="*.jar" />
			</fileset>
		</copy>
		<mkdir dir="${dist}/unsigned" />
		<copy todir="${dist}/unsigned">
			<fileset dir="${dist}/lib">
				<include name="**" />
			</fileset>
		</copy>
				<for list="${deployedDependencyJars}" delimiter="," param="currentjar">
					<sequential>
						<echo message="Current dep: @{currentjar}"/>

						<copy todir="${dist}/unsigned">
							<fileset dir="work/dependency/lib">
								<include name="@{currentjar}"/>
							</fileset>
						</copy>
						<copy todir="${dist}/unsigned">
							<fileset dir="${dist}/lib">
								<include name="@{currentjar}"/>
							</fileset>
						</copy>
					</sequential>
				</for>
			
		

	</target>
	<target name="buildTipi" depends="grabjars">
		<!--  <buildXsd repository="http://www.navajo.nl/Tipi/"/> -->
		<mkdir dir="${dist}" />
		<buildExtension  repository="${repository}" destination="${dist}" version="${tipiComponentVersion}" />
		<echo message="Building to: ${dist}" />
		<echo message="Rep to: ${repository}Extensions/" />
		<buildDocumentation version="${tipiComponentVersion}" distribution="${dist}" destination="${dist}/wikidoc" repository="${repository}Extensions/" />
	</target>
	<target name="repackJars" depends="buildTipi">

		<p200ant repack="true" keepModificationTime="false" singleSegment="true">
		<fileset dir=".">
			<include name="${dist}/lib/*.jar" />
		</fileset>
	</p200ant>
	</target>
	<target name="sign" depends="repackJars">
		<signjar keystore="../TipiBuild/dexels_dummy_key" verbose="false" storepass="dexels" keypass="dexels" alias="java">
			<fileset dir=".">
				<include name="${dist}/lib/*.jar" />
			</fileset>
		</signjar>
	</target>
	<target name="packJars" depends="sign">
	<!-- Don't pack the unsigned jars, for now. -->
	    <p200ant  singleSegment="true">
			<fileset dir=".">
				<include name="${dist}/lib/*.jar" />
			</fileset>
	    </p200ant>
	</target>
	<target name="signPacked" depends="packJars">
		<signjar keystore="../TipiBuild/dexels_dummy_key" verbose="false" storepass="dexels" keypass="dexels" alias="java">
			<fileset dir=".">
				<include name="${dist}/lib/*.jar.pack.gz" />
			</fileset>
		</signjar>
	</target>
		
	<target name="publish" depends="packJars">

		<scp trust="true" sftp="true" verbose="true" todir="${repositorySsh}Extensions/">
			<fileset dir="dist">
				<include name="${ant.project.name}/${tipiComponentVersion}/lib/**" />
				<include name="${ant.project.name}/${tipiComponentVersion}/unsigned/**" />
				<include name="${ant.project.name}/${tipiComponentVersion}/**.jnlp" />
				<include name="${ant.project.name}/${tipiComponentVersion}/definition.xml" />
				<include name="${ant.project.name}/${tipiComponentVersion}/projectinclude.zip" />
				<include name="${ant.project.name}/${tipiComponentVersion}/includes/**" />
				<include name="${ant.project.name}/${tipiComponentVersion}/index.html" />
			</fileset>
		</scp>


		<echo message="Re: ${repositorySsh}Extensions/${ant.project.name}/${tipiComponentVersion}" />
		<!--		<scp trust="true" sftp="true" verbose="true"-->
		<!--			todir="${repositorySsh}/${ant.project.name}/${tipiComponentVersion}">-->
		<!--			<fileset dir="dist">-->
		<!--				<include name="${ant.project.name}/lib/**" />-->
		<!--				<include name="${ant.project.name}/unsigned/**" />-->
		<!--				<include name="${ant.project.name}/**.jnlp" />-->
		<!--				<include name="${ant.project.name}/definition.xml" />-->
		<!--				<include name="${ant.project.name}/includes/**" />-->
		<!--				<include name="${ant.project.name}/index.html" />-->
		<!--			</fileset>-->
		<!--		</scp>-->
		<echo message="Deploying documentation to: ${documentationSsh}" />
		<echo message="Deploying documentation from: ./${dist}/wikidoc/" />
		<scp trust="true" sftp="true" verbose="false" todir="${documentationSsh}/" file="${dist}/wikidoc/tipi.txt">
			<fileset dir="dist/${ant.project.name}/${tipiComponentVersion}/wikidoc">
				<include name="**" />

			</fileset>
		</scp>
		<echo message="Documentation deploy completed at repository: ${repositorySsh}Extensions/" />
		<echo message="from: ${dist}" />

		<scp trust="true" sftp="true" todir="${repositorySsh}Extensions/">
			<fileset dir="${dist}">
				<include name="extensions.xml" />
				<include name="typemap.xml" />
			</fileset>
		</scp>

		<echo message="Tipi deploy completed at repository:" />
		<echo message="JNLP deployed at: ${repository}/Extensions/${ant.project.name}/${ant.project.name}.jnlp" />
	</target>
</project>